<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.10">
<title>Coding Lab - Docker - Kubernetes</title>
<style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */

@import url(https://fonts.googleapis.com/css?family=Ubuntu);
@import "css/asciidoctor.css"; /* Default asciidoc style framework - important */

/* CUSTOMISATIONS */
/* Change the values in root for quick customisation. If you want even more fine grain... venture further. */

:root{
--maincolor:#FFFFFF;
--primarycolor:#E95420;
--secondarycolor:#333333;
--tertiarycolor: #772953;
--sidebarbackground:#CCC;
--linkcolor:#b71c1c;
--linkcoloralternate:#f44336;
--white:#FFFFFF;
--black:#000000;
}

/* Text styles */
body{font-family: "Ubuntu",sans-serif;}

h1,h2{color:var(--primarycolor) !important;font-family:"Ubuntu",sans-serif;}
h3,h4,h5,h6{color:var(--secondarycolor);font-family: "Ubuntu",sans-serif;}
.title{color:(--primarycolor) !important;font-family:"Ubuntu",sans-serif;font-style: normal; font-weight: normal;}
p{font-family: "Ubuntu",sans-serif ! important}
#toc.toc2 a:link{color:white;}
code{background-color: var(--secondarycolor) !important;color:var(--white)}


/* Table styles */
th{background-color: var(--tertiarycolor);color:var(--white) !important;}

#toc.toc2{background-color:#2C001E;color:white;}
#toc.toc2.a{color:white;}
#toctitle{color:#E95420;}

/* Responsiveness fixes */
video {
  max-width: 100%;
}

@media all and (max-width: 600px) {
table {
  width: 55vw!important;
  font-size: 3vw;
}
</style>
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>Coding Lab - Docker - Kubernetes</h1>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_pré_requis">Pré-requis</a></li>
<li><a href="#_liens_utiles">liens utiles</a></li>
<li><a href="#_pour_le_lab">Pour le lab</a>
<ul class="sectlevel2">
<li><a href="#lab-docker">Pour Docker</a></li>
<li><a href="#_pour_kubernetes">Pour Kubernetes</a></li>
</ul>
</li>
<li><a href="#_première_partie_docker">Première Partie - Docker</a>
<ul class="sectlevel2">
<li><a href="#_petite_vidéo_dexplication">Petite Vidéo d&#8217;explication</a></li>
<li><a href="#_q_a">Q &amp; A</a></li>
<li><a href="#_lab">Lab</a></li>
<li><a href="#_ce_qui_ne_sera_pas_vu_dans_ce_lab">Ce qui ne sera pas vu dans ce lab</a></li>
</ul>
</li>
<li><a href="#_deuxième_partie_kubernetes">Deuxième Partie - Kubernetes</a>
<ul class="sectlevel2">
<li><a href="#_mais_cest_quoi_kubernetes">Mais c&#8217;est quoi Kubernetes?</a></li>
<li><a href="#_lab_2">Lab</a></li>
<li><a href="#_ce_qui_ne_sera_pas_vu_dans_ce_lab_2">Ce qui ne sera pas vu dans ce lab</a></li>
</ul>
</li>
<li><a href="#_astuce">Astuce</a>
<ul class="sectlevel2">
<li><a href="#_ecrire_dans_un_fichier_en_ligne_de_commande">Ecrire dans un fichier en ligne de commande</a></li>
<li><a href="#_dashboard_kubernetes">Dashboard Kubernetes</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_pré_requis">Pré-requis</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Un compte github (pour le lab K8s) ou un compte docker (pour le lab K8s et Docker)</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_liens_utiles">liens utiles</h2>
<div class="sectionbody">
<div class="paragraph">
<p>source :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://www.pluralsight.com/courses/getting-started-kubernetes" class="bare">https://www.pluralsight.com/courses/getting-started-kubernetes</a></p>
</li>
<li>
<p><a href="https://kubernetes.io/docs/tutorials/kubernetes-basics/" class="bare">https://kubernetes.io/docs/tutorials/kubernetes-basics/</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_pour_le_lab">Pour le lab</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Plusieurs possibilités pour tester</p>
</div>
<div class="sect2">
<h3 id="lab-docker">Pour Docker</h3>
<div class="ulist">
<ul>
<li>
<p><a href="https://labs.play-with-docker.com/" class="bare">https://labs.play-with-docker.com/</a></p>
</li>
<li>
<p><a href="https://labs.play-with-k8s.com/" class="bare">https://labs.play-with-k8s.com/</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_pour_kubernetes">Pour Kubernetes</h3>
<div class="ulist">
<ul>
<li>
<p><a href="https://labs.play-with-k8s.com/" class="bare">https://labs.play-with-k8s.com/</a></p>
</li>
<li>
<p><a href="https://kubernetes.io/docs/tutorials/kubernetes-basics/" class="bare">https://kubernetes.io/docs/tutorials/kubernetes-basics/</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_première_partie_docker">Première Partie - Docker</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(durée estimée 1h)</p>
</div>
<div class="paragraph">
<p>Docker est une technologie de virtualisation par conteneurs reposant sur le LXC (LinuX Containers)</p>
</div>
<div class="sect2">
<h3 id="_petite_vidéo_dexplication">Petite Vidéo d&#8217;explication</h3>
<div class="videoblock">
<div class="content">
<iframe src="https://www.youtube.com/embed/caXHwYC3tq8?rel=0" frameborder="0" allowfullscreen></iframe>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_q_a">Q &amp; A</h3>
<div class="paragraph">
<p>Rappel :</p>
</div>
<div class="imageblock">
<div class="content">
<img src="assets/docker-structure.jpg" alt="docker structure">
</div>
</div>
</div>
<div class="sect2">
<h3 id="_lab">Lab</h3>
<div class="sect3">
<h4 id="_créer_notre_première_image_et_conteneur">Créer notre première image et conteneur</h4>
<div class="paragraph">
<p>Utilisation du projet "whoami" dans le dossier "docker".</p>
</div>
<div class="paragraph">
<p>1) Lancer le docker lab</p>
</div>
<div class="paragraph">
<p>&#8594; <span id="lab-docker">Voir le lab Docker</span></p>
</div>
<div class="paragraph">
<p>2) Après authentification, création de l&#8217;instance "Create instance"</p>
</div>
<div class="paragraph">
<p>3) lancer la commande dans le terminal</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">docker version</code></pre>
</div>
</div>
<div class="paragraph">
<p>pour s&#8217;assurer que docker est bien présent</p>
</div>
<div class="paragraph">
<p>4) copier le contenu du fichier index.js et l&#8217;intégrer dans le cluster via le terminal (voir astuce pour écrire un fichier)</p>
</div>
<div class="paragraph">
<p>(<em>Description du contenu du fichier</em>)</p>
</div>
<div class="paragraph">
<p>5) copier le contenu du fichier Dockerfile et l&#8217;intégrer dans le cluster via le terminal</p>
</div>
<div class="paragraph">
<p>(<em>Description du contenu du fichier</em>)</p>
</div>
<div class="paragraph">
<p>6) lancer la commande</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">docker build -t whoami .</code></pre>
</div>
</div>
<div class="paragraph">
<p>(<em>Description de la commande</em>)</p>
</div>
<div class="paragraph">
<p>L&#8217;image se créé à partir du contenu décrit dans le Dockerfile</p>
</div>
<div class="paragraph">
<p>on peut vérifier la présence de l&#8217;image via la commande</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">docker images</code></pre>
</div>
</div>
<div class="paragraph">
<p>7) Lancer la commande</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">docker run -d -p 80:80 --name whoami whoami</code></pre>
</div>
</div>
<div class="paragraph">
<p>(<em>Description de la commande</em>)</p>
</div>
<div class="paragraph">
<p>On peut vérifier que le container est opérationnel via la commande</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">docker ps</code></pre>
</div>
</div>
<div class="paragraph">
<p>8) On vérifie l&#8217;accès à l&#8217;application :</p>
</div>
<div class="paragraph">
<p>Un petit "80" s&#8217;affiche au dessus du terminal. il permet d&#8217;accéder à notre serveur web fraichement deployé</p>
</div>
<div class="paragraph">
<p>On peut aussi vérifier en ligne de commande que le hostname correspond bien à celui qui s&#8217;affiche via la commande :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">docker inspect --format '{{ .Config.Hostname}}' whoami</code></pre>
</div>
</div>
<div class="paragraph">
<p>(<em>Description de la commande</em>)</p>
</div>
<div class="paragraph">
<p><strong>Conclusion</strong></p>
</div>
<div class="paragraph">
<p>Nous avons appris des commandes docker qui servent à</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Afficher la version docker</p>
</li>
<li>
<p>Créer et tagguer une image docker</p>
</li>
<li>
<p>Afficher la liste des images présentes sur la machine</p>
</li>
<li>
<p>Instancier un conteneur</p>
</li>
<li>
<p>Lister les conteneurs en cours d&#8217;exécution</p>
</li>
<li>
<p>Inspecter un conteneur en cours d&#8217;exécution</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_récuperer_et_utiliser_une_image_disponible">Récuperer et utiliser une image disponible</h4>
<div class="paragraph">
<p>Utilisation de l&#8217;image nginx.</p>
</div>
<div class="paragraph">
<p>1) Lancer le docker lab si pas déjà fait</p>
</div>
<div class="paragraph">
<p>&#8594; <span id="lab-docker">Voir le lab Docker</span></p>
</div>
<div class="paragraph">
<p>2) Après authentification, création de l&#8217;instance "Create instance"</p>
</div>
<div class="paragraph">
<p>(<em>si c&#8217;est pas déjà fait</em>)</p>
</div>
<div class="paragraph">
<p>3) faire une recherche sur l&#8217;entrepôt d&#8217;images par défaut de docker</p>
</div>
<div class="paragraph">
<p>&#8594; <a href="https://hub.docker.com/" class="bare">https://hub.docker.com/</a></p>
</div>
<div class="paragraph">
<p>de l&#8217;image "nginx" et copier la commande permettant de réaliser un "pull" de l&#8217;image</p>
</div>
<div class="paragraph">
<p>4) Réaliser le pull dans le terminal</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">docker pull nginx</code></pre>
</div>
</div>
<div class="paragraph">
<p>(<em>Description de la commande</em>)</p>
</div>
<div class="paragraph">
<p><em>On verra par la suite que cette étape est facultative</em></p>
</div>
<div class="paragraph">
<p>On vérifie que l&#8217;image est bien présente en local</p>
</div>
<div class="paragraph">
<p><em>Par la commande?</em></p>
</div>
<div class="paragraph">
<p>5) On exécute le container nginx par la commande</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">docker run --name nginx -d -p 8080:80 nginx</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>On utilise ici le port 8080 car le port 80 est déja utilisé par le lab précédent</em></p>
</div>
<div class="paragraph">
<p><em>Le pull de l&#8217;image est facultatif. en lançant la commande de run, docker aurait été chercher l&#8217;image sur le hub si celle-ci n&#8217;existe pas en local.</em></p>
</div>
<div class="paragraph">
<p>6) Une fois tout vérifié et tester, on arrete et supprime les containers via les commandes :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">docker stop whoami
docker rm whoami
docker stop nginx
docker rm nginx</code></pre>
</div>
</div>
<div class="paragraph">
<p>il existe une alternative plus radical en foçant l&#8217;arrêt via les commandes :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">docker rm -f whoami
docker rm -f nginx</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Conclusion</strong></p>
</div>
<div class="paragraph">
<p>Nous avons appris des commandes docker supplémentaires qui servent à</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Récupérer une image docker depuis le hub docker officiel</p>
</li>
<li>
<p>Arréter un container</p>
</li>
<li>
<p>Supprimer un container</p>
</li>
<li>
<p>Forcer l&#8217;arrêt et la suppression du container</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_ce_qui_ne_sera_pas_vu_dans_ce_lab">Ce qui ne sera pas vu dans ce lab</h3>
<div class="paragraph">
<p><em>Mais que vous pourriez par la suite approfondir</em></p>
</div>
<div class="ulist">
<ul>
<li>
<p>le push d&#8217;une image vers un entrepôt</p>
</li>
<li>
<p>Le principe des couches (Layer) au sein de docker qui constitue une image</p>
</li>
<li>
<p>Le build d&#8217;image multilayer</p>
</li>
<li>
<p>le réseau : création, communication inter conteneur etc&#8230;&#8203;</p>
</li>
<li>
<p>la gestion des images et les "insecures registry"</p>
</li>
<li>
<p>docker-compose ou comment démarrer une stack complète.</p>
</li>
<li>
<p>docker-swarm : orchestrateur</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_deuxième_partie_kubernetes">Deuxième Partie - Kubernetes</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(Durée estimé 2h)</p>
</div>
<div class="sect2">
<h3 id="_mais_cest_quoi_kubernetes">Mais c&#8217;est quoi Kubernetes?</h3>
<div class="sect3">
<h4 id="_un_orchestrateur">Un orchestrateur</h4>
<div class="paragraph">
<p>Permet de gérer l&#8217;ensemble des conteneurs décrits dans différents "objets".</p>
</div>
<div class="paragraph">
<p>D&#8217;autres orchestrateurs connus? Swarm, Rancher, Mesos, Nomad</p>
</div>
<div class="paragraph">
<p>(<em>Mais soyons clair, le grand vainqueur reste Kubernetes</em>)</p>
</div>
</div>
<div class="sect3">
<h4 id="_cest_quoi_un_cluster_kubernetes">C&#8217;est quoi un cluster Kubernetes?</h4>
<div class="ulist">
<ul>
<li>
<p>c&#8217;est N master</p>
</li>
<li>
<p>N noeud/serviteur/workeur</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>+-----------------------------------------------------------------------------------------+
|                                                                                         |
|                                             +----------------+     +-----------------+  |
|                                             |                |     |                 |  |
|                                             |     NODE       |     |      NODE       |  |
|                                             |                |     |                 |  |
|                                             |                |     |                 |  |
|     +--------------------------+            +----------------+     +-----------------+  |
|     |                          |                                                        |
|     |  +-----------------------+----+       +----------------+     +-----------------+  |
|     |  |                            |       |                |     |                 |  |
|     |  |    +-----------------------+---+   |     NODE       |     |      NODE       |  |
|     |  |    |                           |   |                |     |                 |  |
|     |  |    |                           |   |                |     |                 |  |
|     |  |    |                           |   +----------------+     +-----------------+  |
|     +--+    |           MASTER          |                                               |
|        |    |                           |   +----------------+     +-----------------+  |
|        |    |                           |   |                |     |                 |  |
|        +----+                           |   |     NODE       |     |      NODE       |  |
|             |                           |   |                |     |                 |  |
|             +---------------------------+   |                |     |                 |  |
|                                             +----------------+     +-----------------+  |
|                                                                                         |
|                                                                                         |
|   K8S CLUSTER                                                                           |
|                                                                                         |
+-----------------------------------------------------------------------------------------+</pre>
</div>
</div>
<div class="paragraph">
<p>En détails :</p>
</div>
<div class="imageblock">
<div class="content">
<img src="assets/kubernetes-constructs-concepts-architecture.jpg" alt="kubernetes constructs concepts architecture">
</div>
</div>
<div class="sect4">
<h5 id="_master">Master</h5>
<div class="paragraph">
<p>Master = Control plane</p>
</div>
<div class="paragraph">
<p>Il est composé de  :</p>
</div>
<div class="paragraph">
<p><em>kube-apiserver</em> : frontend du control plane, expose les api REST et parle avec du JSON (via des fichiers manifest) ou du YAML</p>
</div>
<div class="paragraph">
<p><em>Cluster store (KV) (alias etcd)</em> : persistent storage pour l&#8217;état et la config du cluster. Utilise etcd</p>
</div>
<div class="paragraph">
<p><em>kube-controller-manage</em> : le controller des controllers (gère les noeuds, les endpoints, les namespaces etc&#8230;&#8203;), il gère les evenements/changement et aide à maintenir dans l&#8217;état désiré</p>
</div>
<div class="paragraph">
<p><em>kube-scheduler</em> : va ordonnacer le travail et l&#8217;assigner au noeud selon les contraintes et configuration</p>
</div>
<div class="paragraph">
<p>tout est géré via l&#8217;apiserver qui communique avec les autres composant (KV,Controller,Scheduler)</p>
</div>
</div>
<div class="sect4">
<h5 id="_noeudworkerminion">Noeud/Worker/Minion</h5>
<div class="paragraph">
<p>Il contient :</p>
</div>
<div class="paragraph">
<p><em>Kubelet</em> : l&#8217;agent .</p>
</div>
<div class="paragraph">
<p>Il enregistre le noeud dans le cluster, observe l&#8217;apiserver et communique avec le master</p>
</div>
<div class="paragraph">
<p>Le kubelet ne gère pas l&#8217;état du contenu : il renvoie l&#8217;information au master qui prendra la décision</p>
</div>
<div class="paragraph">
<p>Il exposes les endpoints sur le port :10255 &#8658; il expose par exemple 3 endpoints /spec /healthz /pods (il y en a d&#8217;autre)</p>
</div>
<div class="paragraph">
<p>Il contient le container engine : qui permet de réaliser le pull des images, démarrer et arreter les containers. Le Container Engine est pluggé avec Docker mais peut être plugger à d&#8217;autre (rkt, containerd, podman etc..)</p>
</div>
<div class="paragraph">
<p>kube-proxy : va gérer toute la partie réseau, assigner une adresse ip pour chaque pod, gérer la partie loadbalancing etc..</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_liste_des_ressources_de_kubernetes">Liste des ressources de Kubernetes</h4>
<div class="imageblock">
<div class="content">
<img src="assets/ressources-map.png" alt="ressources map">
</div>
</div>
<div class="paragraph">
<p>Plus d&#8217;infos sur les icônes : <a href="https://github.com/kubernetes/community/tree/master/icons" class="bare">https://github.com/kubernetes/community/tree/master/icons</a></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_lab_2">Lab</h3>
<div class="paragraph">
<p>Pour communiquer avec le cluster kubernetes, nous utilisons la CLI "kubectl" qui permet de dialoguer.</p>
</div>
<div class="paragraph">
<p>Il est possible soit d&#8217;utiliser des actions de type "run" ou "create", soit d&#8217;appliquer directement des fichiers descripteurs de type "yaml" ou "json".</p>
</div>
<div class="sect3">
<h4 id="_préparation_du_lab">Préparation du lab</h4>
<div class="paragraph">
<p>Utilisation des liens :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://labs.play-with-k8s.com/" class="bare">https://labs.play-with-k8s.com/</a> &#8658; Nécessite un compte github ou docker</p>
</li>
<li>
<p><a href="https://kubernetes.io/docs/tutorials/kubernetes-basics/" class="bare">https://kubernetes.io/docs/tutorials/kubernetes-basics/</a> &#8658; Aucun besoin</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_pod">Pod</h4>
<div class="paragraph">
<p>Démarrons par le plus petit élément à savoir le pod.</p>
</div>
<div class="paragraph">
<p>Le pod est constitué de 1 à n conteneur : dans la pratique on limite à 1 conteneur par pod.</p>
</div>
<div class="paragraph">
<p>Création du premier pod :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">kubectl run whoami --image=jufab/whoami:latest --port=80 --generator=run-pod/v1</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_deployment">Deployment</h4>

</div>
<div class="sect3">
<h4 id="_service">Service</h4>

</div>
</div>
<div class="sect2">
<h3 id="_ce_qui_ne_sera_pas_vu_dans_ce_lab_2">Ce qui ne sera pas vu dans ce lab</h3>

</div>
</div>
</div>
<div class="sect1">
<h2 id="_astuce">Astuce</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_ecrire_dans_un_fichier_en_ligne_de_commande">Ecrire dans un fichier en ligne de commande</h3>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">cat &gt; nomdufichier &lt;&lt; eof
&gt; blabla
&gt; eof</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_dashboard_kubernetes">Dashboard Kubernetes</h3>
<div class="paragraph">
<p>kubectl apply -f <a href="https://raw.githubusercontent.com/kubernetes/dashboard/v2.0.0-beta4/aio/deploy/recommended.yaml" class="bare">https://raw.githubusercontent.com/kubernetes/dashboard/v2.0.0-beta4/aio/deploy/recommended.yaml</a></p>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2019-10-29 01:17:35 +0100
</div>
</div>
</body>
</html>