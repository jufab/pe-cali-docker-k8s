<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.10">
<title>Coding Lab - Docker - Kubernetes</title>
<style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */

@import url(https://fonts.googleapis.com/css?family=Ubuntu);
@import "css/asciidoctor.css"; /* Default asciidoc style framework - important */

/* CUSTOMISATIONS */
/* Change the values in root for quick customisation. If you want even more fine grain... venture further. */

:root{
--maincolor:#FFFFFF;
--primarycolor:#E95420;
--secondarycolor:#333333;
--tertiarycolor: #772953;
--sidebarbackground:#CCC;
--linkcolor:#b71c1c;
--linkcoloralternate:#f44336;
--white:#FFFFFF;
--black:#000000;
--greycode:#F7F7F8;
}

/* Text styles */
body{font-family: "Ubuntu",sans-serif;}

h1,h2,h5{color:var(--primarycolor) !important;font-family:"Ubuntu",sans-serif;}
h3,h4,h6{color:var(--secondarycolor);font-family: "Ubuntu",sans-serif;}
.title{color:(--primarycolor) !important;font-family:"Ubuntu",sans-serif;font-style: normal; font-weight: normal;}
p{font-family: "Ubuntu",sans-serif ! important}
#toc.toc2 a:link{color:white;}
code{background-color: var(--greycode) !important;color:var(--white)}


/* Table styles */
th{background-color: var(--tertiarycolor);color:var(--white) !important;}

#toc.toc2{background-color:#2C001E;color:white;}
#toc.toc2.a{color:white;}
#toctitle{color:#E95420;}

/* Responsiveness fixes */
video {
  max-width: 100%;
}

@media all and (max-width: 600px) {
table {
  width: 55vw!important;
  font-size: 3vw;
}

</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>Coding Lab - Docker - Kubernetes</h1>
<div id="toc" class="toc2">
<div id="toctitle">Sommaire</div>
<ul class="sectlevel1">
<li><a href="#_prérequis">Prérequis</a></li>
<li><a href="#_pour_le_lab">Pour le lab</a>
<ul class="sectlevel2">
<li><a href="#lab-docker">Pour Docker</a></li>
<li><a href="#_pour_kubernetes">Pour Kubernetes</a></li>
</ul>
</li>
<li><a href="#_première_partie_docker">Première Partie - Docker</a>
<ul class="sectlevel2">
<li><a href="#_petite_vidéo_dexplication">Petite vidéo d&#8217;explication</a></li>
<li><a href="#_q_a">Q &amp; A</a></li>
<li><a href="#_lab">Lab</a>
<ul class="sectlevel3">
<li><a href="#_créer_notre_première_image_et_conteneur">Créer notre première image et conteneur</a></li>
<li><a href="#_récupérer_et_utiliser_une_image_disponible">Récupérer et utiliser une image disponible</a></li>
</ul>
</li>
<li><a href="#_ce_qui_ne_sera_pas_vu_dans_ce_lab">Ce qui ne sera pas vu dans ce lab</a></li>
</ul>
</li>
<li><a href="#_deuxième_partie_kubernetes">Deuxième Partie - Kubernetes</a>
<ul class="sectlevel2">
<li><a href="#_mais_cest_quoi_kubernetes">Mais c&#8217;est quoi Kubernetes?</a>
<ul class="sectlevel3">
<li><a href="#_un_orchestrateur">Un orchestrateur</a></li>
<li><a href="#_cest_quoi_un_cluster_kubernetes">C&#8217;est quoi un cluster Kubernetes?</a></li>
<li><a href="#_liste_des_ressources_de_kubernetes">Liste des ressources de Kubernetes</a></li>
</ul>
</li>
<li><a href="#_lab_2">Lab</a>
<ul class="sectlevel3">
<li><a href="#_préparation_du_lab">Préparation du lab</a></li>
<li><a href="#_pod">Pod</a></li>
<li><a href="#_deployment">Deployment</a></li>
<li><a href="#_service">Service</a></li>
<li><a href="#_namespace">Namespace</a></li>
</ul>
</li>
<li><a href="#_ce_qui_ne_sera_pas_vu_dans_ce_lab_2">Ce qui ne sera pas vu dans ce lab</a></li>
<li><a href="#_kubectl">Kubectl</a></li>
</ul>
</li>
<li><a href="#_annexe">Annexe</a>
<ul class="sectlevel2">
<li><a href="#_source">source</a></li>
<li><a href="#_nom_court_des_ressources_kubernetes">Nom court des ressources Kubernetes</a></li>
</ul>
</li>
<li><a href="#_astuce">Astuce</a>
<ul class="sectlevel2">
<li><a href="#_écrire_dans_un_fichier_en_ligne_de_commande">Écrire dans un fichier en ligne de commande</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_prérequis">Prérequis</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Un compte GitHub (pour le lab K8s) ou un compte docker (pour le lab K8s et Docker)</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_pour_le_lab">Pour le lab</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Plusieurs possibilités pour tester</p>
</div>
<div class="sect2">
<h3 id="lab-docker">Pour Docker</h3>
<div class="ulist">
<ul>
<li>
<p><a href="https://labs.play-with-docker.com/" class="bare">https://labs.play-with-docker.com/</a> (nécessite un compte "docker")</p>
</li>
<li>
<p><a href="https://labs.play-with-k8s.com/" class="bare">https://labs.play-with-k8s.com/</a> (nécessite un compte "docker" ou GitHub)</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_pour_kubernetes">Pour Kubernetes</h3>
<div class="ulist">
<ul>
<li>
<p><a href="https://labs.play-with-k8s.com/" class="bare">https://labs.play-with-k8s.com/</a> (nécessite un compte "docker" ou GitHub)</p>
</li>
<li>
<p><a href="https://kubernetes.io/docs/tutorials/kubernetes-basics/" class="bare">https://kubernetes.io/docs/tutorials/kubernetes-basics/</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>On favorisera l&#8217;utilisation du lien <a href="https://labs.play-with-k8s.com/" class="bare">https://labs.play-with-k8s.com/</a> pour tout faire au même endroit.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_première_partie_docker">Première Partie - Docker</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(durée estimée 1h)</p>
</div>
<div class="paragraph">
<p>Docker est une technologie de virtualisation par conteneurs reposant sur le LXC (LinuX Containers)</p>
</div>
<div class="sect2">
<h3 id="_petite_vidéo_dexplication">Petite vidéo d&#8217;explication</h3>
<div class="videoblock">
<div class="content">
<iframe src="https://www.youtube.com/embed/caXHwYC3tq8?rel=0" frameborder="0" allowfullscreen></iframe>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_q_a">Q &amp; A</h3>
<div class="paragraph">
<p>Rappel :</p>
</div>
<div class="imageblock">
<div class="content">
<img src="assets/docker-structure.jpg" alt="docker structure">
</div>
</div>
</div>
<div class="sect2">
<h3 id="_lab">Lab</h3>
<div class="sect3">
<h4 id="_créer_notre_première_image_et_conteneur">Créer notre première image et conteneur</h4>
<div class="paragraph">
<p>Utilisation du projet "whoami" dans le dossier "docker".</p>
</div>
<div class="paragraph">
<p>1) Lancer le docker lab</p>
</div>
<div class="paragraph">
<p>&#8594; <a href="#_pour_le_lab">Voir le lab Docker</a></p>
</div>
<div class="paragraph">
<p>2) Après authentification, création de l&#8217;instance "Create instance"</p>
</div>
<div class="paragraph">
<p>3) lancer la commande dans le terminal</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">docker version</code></pre>
</div>
</div>
<div class="paragraph">
<p>pour s&#8217;assurer que docker est bien présent</p>
</div>
<div class="paragraph">
<p>4) copier le contenu du fichier index.js et l&#8217;intégrer dans le cluster via le terminal</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">cat &gt; index.js &lt;&lt; eof
var http = require('http');
var os = require('os');
http.createServer(function(req,res){
    res.writeHead(200, {'Content-Type': 'text/plain'});
    res.write('Hostname : ' + os.hostname());
    res.end();
}).listen(80);
eof</code></pre>
</div>
</div>
<div class="paragraph">
<p>(<em>Description du contenu du fichier</em>)</p>
</div>
<div class="paragraph">
<p>5) copier le contenu du fichier Dockerfile et l&#8217;intégrer dans le cluster via le terminal</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">cat &gt; Dockerfile &lt;&lt; eof
FROM node:alpine
COPY index.js index.js
CMD [ "node", "index.js" ]
EXPOSE 80
eof</code></pre>
</div>
</div>
<div class="paragraph">
<p>(<em>Description du contenu du fichier</em>)</p>
</div>
<div class="paragraph">
<p>6) lancer la commande</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">docker build -t whoami .</code></pre>
</div>
</div>
<div class="paragraph">
<p>(<em>Description de la commande</em>)</p>
</div>
<div class="paragraph">
<p>L&#8217;image se créé à partir du contenu décrit dans le Dockerfile</p>
</div>
<div class="paragraph">
<p>on peut vérifier la présence de l&#8217;image via la commande</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">docker images</code></pre>
</div>
</div>
<div class="paragraph">
<p>7) Lancer la commande</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">docker run -d -p 80:80 --name whoami whoami</code></pre>
</div>
</div>
<div class="paragraph">
<p>(<em>Description de la commande</em>)</p>
</div>
<div class="paragraph">
<p>On peut vérifier que le container est opérationnel via la commande</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">docker ps</code></pre>
</div>
</div>
<div class="paragraph">
<p>8) On vérifie l&#8217;accès à l&#8217;application :</p>
</div>
<div class="paragraph">
<p>Un petit "80" s&#8217;affiche au-dessus du terminal. Il permet d&#8217;accéder à notre serveur web fraichement déployé.</p>
</div>
<div class="paragraph">
<p>On peut aussi vérifier en ligne de commande que le hostname correspond bien à celui qui s&#8217;affiche via la commande :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">docker inspect --format '{{ .Config.Hostname}}' whoami</code></pre>
</div>
</div>
<div class="paragraph">
<p>(<em>Description de la commande</em>)</p>
</div>
<div class="paragraph">
<p><strong>Conclusion</strong></p>
</div>
<div class="paragraph">
<p>Nous avons appris des commandes docker qui servent à</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Afficher la version docker</p>
</li>
<li>
<p>Créer et tagguer une image docker</p>
</li>
<li>
<p>Afficher la liste des images présentes sur la machine</p>
</li>
<li>
<p>Instancier un conteneur</p>
</li>
<li>
<p>Lister les conteneurs en cours d&#8217;exécution</p>
</li>
<li>
<p>Inspecter un conteneur en cours d&#8217;exécution</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_récupérer_et_utiliser_une_image_disponible">Récupérer et utiliser une image disponible</h4>
<div class="paragraph">
<p>Utilisation de l&#8217;image nginx.</p>
</div>
<div class="paragraph">
<p>1) Lancer le docker lab si pas déjà fait</p>
</div>
<div class="paragraph">
<p>&#8594; <a href="#_pour_le_lab">Voir le lab Docker</a></p>
</div>
<div class="paragraph">
<p>2) Après authentification, création de l&#8217;instance "Create instance"</p>
</div>
<div class="paragraph">
<p>(<em>Si ce n&#8217;est pas déjà fait</em>)</p>
</div>
<div class="paragraph">
<p>3) faire une recherche sur l&#8217;entrepôt d&#8217;images par défaut de docker</p>
</div>
<div class="paragraph">
<p>&#8594; <a href="https://hub.docker.com/" class="bare">https://hub.docker.com/</a></p>
</div>
<div class="paragraph">
<p>de l&#8217;image "nginx" et copier la commande permettant de réaliser un "pull" de l&#8217;image</p>
</div>
<div class="paragraph">
<p>4) Réaliser le pull dans le terminal</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">docker pull nginx</code></pre>
</div>
</div>
<div class="paragraph">
<p>(<em>Description de la commande</em>)</p>
</div>
<div class="paragraph">
<p><em>On verra par la suite que cette étape est facultative</em></p>
</div>
<div class="paragraph">
<p>On vérifie que l&#8217;image est bien présente en local</p>
</div>
<div class="paragraph">
<p><em>Par la commande?</em></p>
</div>
<div class="paragraph">
<p>5) On exécute le container nginx par la commande</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">docker run --name nginx -d -p 8080:80 nginx</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>On utilise ici le port 8080 car le port 80 est déjà utilisé par le lab précédent</em></p>
</div>
<div class="paragraph">
<p><em>Le pull de l&#8217;image est facultatif. en lançant la commande de run, docker aurait été chercher l&#8217;image sur le hub si celle-ci n&#8217;existe pas en local.</em></p>
</div>
<div class="paragraph">
<p>6) Une fois tout vérifié et tester, on arrête et supprime les containers via les commandes :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">docker stop whoami
docker rm whoami
docker stop nginx
docker rm nginx</code></pre>
</div>
</div>
<div class="paragraph">
<p>Il existe une alternative plus radicale en forçant l&#8217;arrêt via les commandes :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">docker rm -f whoami
docker rm -f nginx</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Conclusion</strong></p>
</div>
<div class="paragraph">
<p>Nous avons appris des commandes docker supplémentaires qui servent à</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Récupérer une image docker depuis le hub docker officiel</p>
</li>
<li>
<p>Arrêter un container</p>
</li>
<li>
<p>Supprimer un container</p>
</li>
<li>
<p>Forcer l&#8217;arrêt et la suppression du container</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_ce_qui_ne_sera_pas_vu_dans_ce_lab">Ce qui ne sera pas vu dans ce lab</h3>
<div class="paragraph">
<p><em>Mais que vous pourriez par la suite approfondir</em></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Le push d&#8217;une image vers un entrepôt</p>
</li>
<li>
<p>Le principe des couches (Layer) au sein de docker qui constitue une image</p>
</li>
<li>
<p>Le build d&#8217;image multilayer</p>
</li>
<li>
<p>Le réseau : création, communication inter conteneur etc&#8230;&#8203;</p>
</li>
<li>
<p>La gestion des images, les "registry" et les "insecures registry"</p>
</li>
<li>
<p>Docker-compose ou comment démarrer une stack complète.</p>
</li>
<li>
<p>Docker Swarm : orchestrateur</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_deuxième_partie_kubernetes">Deuxième Partie - Kubernetes</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(Durée estimé 2h)</p>
</div>
<div class="sect2">
<h3 id="_mais_cest_quoi_kubernetes">Mais c&#8217;est quoi Kubernetes?</h3>
<div class="sect3">
<h4 id="_un_orchestrateur">Un orchestrateur</h4>
<div class="paragraph">
<p>Permet de gérer l&#8217;ensemble des conteneurs décrits dans différents "objets".</p>
</div>
<div class="paragraph">
<p>D&#8217;autres orchestrateurs connus ? Swarm, Rancher, Mesos, Nomad</p>
</div>
<div class="paragraph">
<p>(<em>Mais soyons clair, le grand vainqueur reste Kubernetes</em>)</p>
</div>
</div>
<div class="sect3">
<h4 id="_cest_quoi_un_cluster_kubernetes">C&#8217;est quoi un cluster Kubernetes?</h4>
<div class="ulist">
<ul>
<li>
<p>C&#8217;est N master</p>
</li>
<li>
<p>N noeud/serviteur/workeur</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>+-----------------------------------------------------------------------------------------+
|                                                                                         |
|                                             +----------------+     +-----------------+  |
|                                             |                |     |                 |  |
|                                             |     NODE       |     |      NODE       |  |
|                                             |                |     |                 |  |
|                                             |                |     |                 |  |
|     +--------------------------+            +----------------+     +-----------------+  |
|     |                          |                                                        |
|     |  +-----------------------+----+       +----------------+     +-----------------+  |
|     |  |                            |       |                |     |                 |  |
|     |  |    +-----------------------+---+   |     NODE       |     |      NODE       |  |
|     |  |    |                           |   |                |     |                 |  |
|     |  |    |                           |   |                |     |                 |  |
|     |  |    |                           |   +----------------+     +-----------------+  |
|     +--+    |           MASTER          |                                               |
|        |    |                           |   +----------------+     +-----------------+  |
|        |    |                           |   |                |     |                 |  |
|        +----+                           |   |     NODE       |     |      NODE       |  |
|             |                           |   |                |     |                 |  |
|             +---------------------------+   |                |     |                 |  |
|                                             +----------------+     +-----------------+  |
|                                                                                         |
|                                                                                         |
|   K8S CLUSTER                                                                           |
|                                                                                         |
+-----------------------------------------------------------------------------------------+</pre>
</div>
</div>
<div class="paragraph">
<p>En détails :</p>
</div>
<div class="imageblock">
<div class="content">
<img src="assets/kubernetes-constructs-concepts-architecture.jpg" alt="kubernetes constructs concepts architecture">
</div>
</div>
<div class="sect4">
<h5 id="_master">Master</h5>
<div class="paragraph">
<p><a href="https://kubernetes.io/fr/docs/concepts/overview/components/#composants-master"><em>Master</em> ou Control plane</a></p>
</div>
<div class="paragraph">
<p>Il est composé de  :</p>
</div>
<hr>
<div class="paragraph">
<p><em>kube-apiserver</em> : frontend du control plane, expose les api REST et travaille avec le format avec du JSON (via des fichiers manifest) ou du YAML</p>
</div>
<hr>
<div class="paragraph">
<p><em>Cluster store (KV) (alias etcd)</em> : persistent storage pour l&#8217;état et la config du cluster. Utilise <a href="https://github.com/etcd-io/etcd">etcd</a></p>
</div>
<hr>
<div class="paragraph">
<p><em>kube-controller-manager</em> : le controller des controllers (gère les noeuds, les endpoints, les namespaces etc&#8230;&#8203;), il gère les évènements/changement et aide à maintenir dans l&#8217;état désiré</p>
</div>
<hr>
<div class="paragraph">
<p><em>kube-scheduler</em> : va ordonnancer le travail et l&#8217;assigner au noeud selon les contraintes et configuration</p>
</div>
<hr>
<div class="paragraph">
<p>tout est géré via l&#8217;apiserver qui communique avec les autres composant (KV,Controller,Scheduler)</p>
</div>
</div>
<div class="sect4">
<h5 id="_noeudworkerminion">Noeud/Worker/Minion</h5>
<div class="paragraph">
<p><a href="https://kubernetes.io/fr/docs/concepts/overview/components/#composants-de-n%c5%93ud">Noeud</a></p>
</div>
<div class="paragraph">
<p>Il contient :</p>
</div>
<hr>
<div class="paragraph">
<p><em>Kubelet</em> : l&#8217;agent. Il enregistre le noeud dans le cluster, observe l&#8217;apiserver et communique avec le master.
Le kubelet ne gère pas l&#8217;état du contenu : il renvoie l&#8217;information au master qui prendra la décision.
Il expose les endpoints sur le port :10255 &#8658; il expose par exemple 3 endpoints /spec /healthz /pods (il y en a d&#8217;autre)</p>
</div>
<hr>
<div class="paragraph">
<p><em>container engine</em> : il permet de réaliser le pull des images, démarrer et arrêter les containers. Le Container Engine est pluggé en règle générale avec Docker mais peut être pluggé à d&#8217;autres (rktlet, containerd, cri-o, etc..) compatible avec Kubernetes CRI (Container Runtime Interface)</p>
</div>
<hr>
<div class="paragraph">
<p>kube-proxy : va gérer toute la partie réseau, assigner une adresse ip pour chaque pod, gérer la partie communication entre les pods etc..</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_liste_des_ressources_de_kubernetes">Liste des ressources de Kubernetes</h4>
<div class="imageblock">
<div class="content">
<img src="assets/ressources-map.png" alt="ressources map">
</div>
</div>
<div class="paragraph">
<p>Plus d&#8217;infos sur les icônes : <a href="https://github.com/kubernetes/community/tree/master/icons" class="bare">https://github.com/kubernetes/community/tree/master/icons</a></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_lab_2">Lab</h3>
<div class="paragraph">
<p>Pour communiquer avec le cluster kubernetes, nous utilisons la CLI "kubectl" qui permet de dialoguer avec le cluster.</p>
</div>
<div class="paragraph">
<p>Il est possible soit d&#8217;utiliser des actions de type "run" ou "create", soit d&#8217;appliquer directement des fichiers descripteurs de type "yaml" ou "json".</p>
</div>
<div class="paragraph">
<p>Nous allons travailler dans ce lab, la majorité du temps, via des fichiers yaml.</p>
</div>
<div class="sect3">
<h4 id="_préparation_du_lab">Préparation du lab</h4>
<div class="paragraph">
<p>On continue sur <a href="https://labs.play-with-k8s.com/" class="bare">https://labs.play-with-k8s.com/</a></p>
</div>
<div class="paragraph">
<p>On ajoute une instance et on démarre l&#8217;instruction 1</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">kubeadm init --apiserver-advertise-address $(hostname -i)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notez bien durant l&#8217;initialisation de l&#8217;instruction 1, la commande suivante type qui vous sera donnée :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">kubeadm join XXX.XXX.XXX.XXX:XXXX --token xxxxxxxxx --discovery-token-ca-cert-hash xxxxxxxxxxx</code></pre>
</div>
</div>
<div class="paragraph">
<p>et on démarre l&#8217;instruction 2</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">kubectl apply -n kube-system -f \
    "https://cloud.weave.works/k8s/net?k8s-version=$(kubectl version | base64 |tr -d '\n')"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Sur l&#8217;instance du précédant lab, appliquer la commande "kubeadm join&#8230;&#8203;" précieusement conservée.</p>
</div>
<div class="paragraph">
<p>Pour vérifier que tout va bien on vérifie qu&#8217;il existe 2 noeuds dans notre cluster dont 1 master via :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">kubectl get nodes</code></pre>
</div>
</div>
<div class="paragraph">
<p>SI la réponse est : <em>The connection to the server localhost:8080 was refused - did you specify the right host or port?</em> c&#8217;est que vous n&#8217;êtes pas sur le noeud maître. Retenter la commande sur le 2ème noeud.</p>
</div>
</div>
<div class="sect3">
<h4 id="_pod">Pod</h4>
<div class="paragraph">
<p>Démarrons par le plus petit élément à savoir le pod.</p>
</div>
<div class="paragraph">
<p>Le pod est constitué de 1 à n conteneur : dans la pratique on limite à 1 conteneur par pod.</p>
</div>
<div class="paragraph">
<p>1) Création du premier pod (en version Ligne de commande):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">kubectl run whoami --image=whoami:latest --port=80 --generator=run-pod/v1</code></pre>
</div>
</div>
<div class="paragraph">
<p>On vérifie via la commande</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">kubectl get po</code></pre>
</div>
</div>
<div class="paragraph">
<p>(<em>Description de la commande</em>)</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<em>po</em> est un nom court de pod. on peut écrire soit <em>po</em> soit <em>pod</em>.
<a href="#_nom_court_des_ressources_kubernetes">nom court des ressources Kubernetes</a>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>On doit obtenir</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">NAME      READY     STATUS    RESTARTS   AGE
whoami    1/1       Running   0          9m</code></pre>
</div>
</div>
<div class="paragraph">
<p>2) Réalisons la même commande mais via un fichier yaml.</p>
</div>
<div class="paragraph">
<p>On supprime d&#8217;abord le pod fraîchement créé.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">kubectl delete po whoami</code></pre>
</div>
</div>
<div class="paragraph">
<p>et on crée le nouveau à l&#8217;aide du fichier yaml "pod.yaml" que l&#8217;on va lui aussi créer</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">cat &gt; pod.yaml &lt;&lt; eof
apiVersion: v1
kind: Pod
metadata:
  name: whoami
  labels:
    name: whoami
spec:
  containers:
  - name: whoami
    image: whoami:latest
    imagePullPolicy: IfNotPresent
    ports:
      - containerPort: 80
eof
kubectl apply -f pod.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>On vérifie que le pod est créé et qu&#8217;il est opérationnel</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">kubectl get po</code></pre>
</div>
</div>
<div class="paragraph">
<p>On doit obtenir</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">NAME      READY     STATUS    RESTARTS   AGE
whoami    1/1       Running   0          9m</code></pre>
</div>
</div>
<div class="paragraph">
<p>Il est possible de définir des ressources au niveau du pod qui seront nécessaires au bon fonctionnement et qui pourra être nécessaire dans le choix du noeud exécutant le pod.</p>
</div>
<div class="paragraph">
<p>Il est aussi possible de définir une valeur limite qui pourrait engendrer l&#8217;arrêt du pod si celui-ci les dépasse.</p>
</div>
<div class="paragraph">
<p>un exemple :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">kubectl delete pod whoami
cat &gt; pod-resource.yaml &lt;&lt; eof
apiVersion: v1
kind: Pod
metadata:
  name: whoami
  labels:
    name: whoami
spec:
  containers:
  - name: whoami
    image: whoami:latest
    imagePullPolicy: IfNotPresent
    ports:
      - containerPort: 80
    resources:
      requests:
        memory: 100M
        cpu: "0.1"
      limits:
        memory: 150M
        cpu: "0.4"
eof
kubectl apply -f pod-resource.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Il existe aussi au niveau du pod 2 sondes essentiels permettant de vérifier l&#8217;état du pod ou de garantir que celui est prêt.
Il s&#8217;agit des sondes suivantes :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>LivenessProbe : indique si le conteneur est en cours d&#8217;exécution</p>
</li>
<li>
<p>ReadinessProbe : indique si le conteneur est prêt à recevoir du traffic</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
il existe une troisième sonde (startupProbe) orientée pour des applications legacy ou lourdes qui requière un temps de démarrage conséquent. Cette sonde désactive toutes les sondes tant que le contenuer n&#8217;est pas démarré.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Voici un exemple:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">kubectl delete pod whoami
cat &gt; pod-probe.yaml &lt;&lt; eof
apiVersion: v1
kind: Pod
metadata:
  name: whoami
  labels:
    name: whoami
spec:
  containers:
  - name: whoami
    image: whoami:latest
    imagePullPolicy: IfNotPresent
    ports:
      - containerPort: 80
        name: whoami-port
    resources:
        requests:
          memory: 100M
          cpu: "0.1"
        limits:
          memory: 150M
          cpu: "0.4"
    livenessProbe:
      httpGet:
        path: /
        port: whoami-port
      initialDelaySeconds: 2
      periodSeconds: 3
    readinessProbe:
      httpGet:
        path: /
        port: whoami-port
      initialDelaySeconds: 2
      periodSeconds: 3
eof
kubectl apply -f pod-probe.yaml</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_deployment">Deployment</h4>
<div class="paragraph">
<p>Suite à la création du pod, nous allons voir dans cette partie comment gérer le nombre d&#8217;instance de notre application.</p>
</div>
<div class="paragraph">
<p>Pour réaliser cette gestion, il est recommandé d&#8217;utiliser une ressource "deployment".</p>
</div>
<div class="paragraph">
<p>Réalisons le déploiement de l&#8217;application via 2 pods.</p>
</div>
<div class="paragraph">
<p>1) Pour se faire, nous allons créer le fichier "deployment.yaml" et nous allons l&#8217;appliquer</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">cat &gt; deployment.yaml &lt;&lt; eof
apiVersion: apps/v1
kind: Deployment
metadata:
  name: whoami
spec:
  replicas: 2
  selector:
    matchLabels:
      app: whoami
  template:
    metadata:
      labels:
        app: whoami
    spec:
      containers:
      - name: whoami
        image: whoami:latest
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 80
eof
kubectl apply -f deployment.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>2) On vérifie la présence des 2 pods et du déploiement via la commande :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">kubectl get po,deploy</code></pre>
</div>
</div>
<div class="paragraph">
<p>On obtient</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">NAME                          READY     STATUS    RESTARTS   AGE
pod/whoami-59494cdf4c-gx5n9   0/1       Pending   0          18s
pod/whoami-59494cdf4c-w7w96   0/1       Pending   0          18s

NAME                           DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
deployment.extensions/whoami   2         2         2            2           18s</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Le nom des pods sont générés à la suite de la déclaration dans le déploiement.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>3) On passe le nombre d&#8217;instance de pods de 2 à 3.</p>
</div>
<div class="paragraph">
<p>Pour se faire on utilise la commande suivante :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">kubectl scale --replicas=3 deployment/whoami</code></pre>
</div>
</div>
<div class="paragraph">
<p>le nombre d&#8217;instance passe à 3 par service</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">kubectl get rs</code></pre>
</div>
</div>
<div class="paragraph">
<p>on obtient :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">NAME      DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
whoami    3         3         3            3           6m</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_service">Service</h4>
<div class="paragraph">
<p>Un service est une ressource permettant d&#8217;accéder à un ensemble de pods défini par un sélecteur.</p>
</div>
<div class="paragraph">
<p>Un service va permettre d&#8217;exposer des pods et pouvoir y accéder sans que l&#8217;on est besoin d&#8217;avoir la moindre information au sujet des pods qu&#8217;il expose.</p>
</div>
<div class="paragraph">
<p>Le sélecteur des pods dans le service va se définir via des labels que les pods possèdent.</p>
</div>
<div class="paragraph">
<p>Le service va permettre aussi d&#8217;exposer celui-ci sur un port différent de celui du pod</p>
</div>
<div class="paragraph">
<p>1) On crée un service via un fichier "service.yaml"</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">cat &gt; service.yaml &lt;&lt; eof
apiVersion: v1
kind: Service
metadata:
  name: whoami
spec:
  selector:
    app: whoami
  ports:
  - port: 80
    targetPort: 80
eof
kubectl apply -f service.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>2) On vérifie la création de ce service via</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">kubectl get svc</code></pre>
</div>
</div>
<div class="paragraph">
<p>qui nous donnera</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">NAME         TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE
kubernetes   ClusterIP   10.96.0.1       &lt;none&gt;        443/TCP   17m
whoami       ClusterIP   10.108.134.96   &lt;none&gt;        80/TCP    11s</code></pre>
</div>
</div>
<div class="paragraph">
<p>Comment ça marche un service?</p>
</div>
<div class="paragraph">
<p>Le service pointe vers un endpoint. Le endpoint rafraichit régulièrement la liste des IP des pods correspondant au sélecteur.
Le service a ainsi l&#8217;ensemble des adresses ip des pods pour communiquer.</p>
</div>
<div class="paragraph">
<p>Pour visualiser un endpoint :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">kubectl get endpoints whoami</code></pre>
</div>
</div>
<div class="paragraph">
<p>donnera :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">NAME      ENDPOINTS                   AGE
whoami    10.44.0.1:80,10.44.0.2:80   2m</code></pre>
</div>
</div>
<hr>
<div class="paragraph">
<p>Dans la description, il manque une information au niveau ".spec.type" qui permet de spécifier le type du service.</p>
</div>
<div class="paragraph">
<p>Il existe trois types:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>ClusterIP : service non exposé en dehors du cluster, mais accessible par les membres du cluster</p>
</li>
<li>
<p>NodePort : réserve un port qui sera appliqué à l&#8217;ensemble du cluster (réservation) généralement entre 30000 - 32767</p>
</li>
<li>
<p>LoadBalancer : provisionne une adresse IP externe par l&#8217;intermédiaire de la plateforme.</p>
</li>
</ul>
</div>
<hr>
<div class="paragraph">
<p>Type LoadBalancer</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">cat &gt; service-loadbalancer.yaml &lt;&lt; eof
apiVersion: v1
kind: Service
metadata:
  name: whoami
spec:
  type: LoadBalancer
  selector:
    app: whoami
  ports:
  - port: 80
    targetPort: 80
eof
kubectl apply -f service-loadbalancer.yaml</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">NAME         TYPE           CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE
kubernetes   ClusterIP      10.96.0.1       &lt;none&gt;        443/TCP        46m
whoami       LoadBalancer   10.109.74.243   &lt;pending&gt;     80:31592/TCP   11s</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Si la plateforme (comme c&#8217;est le cas ici) n&#8217;a pas de service permettant d&#8217;obtenir une adresse externe, alors elle reste à l&#8217;état pending.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Type NodePort :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">cat &gt; service-nodeport.yaml &lt;&lt; eof
apiVersion: v1
kind: Service
metadata:
  name: whoami
spec:
  type: NodePort
  selector:
    app: whoami
  ports:
  - port: 80
    targetPort: 80
eof
kubectl apply -f service-nodeport.yaml</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">NAME         TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE
kubernetes   ClusterIP   10.96.0.1       &lt;none&gt;        443/TCP        39m
whoami       NodePort    10.109.63.115   &lt;none&gt;        80:31178/TCP   34m</code></pre>
</div>
</div>
<div class="paragraph">
<p>On peut accéder à la ressource via l&#8217;url externe + le port attribué par NodePort.
Dans l&#8217;exemple au-dessus il s&#8217;agit du port 31178</p>
</div>
</div>
<div class="sect3">
<h4 id="_namespace">Namespace</h4>
<div class="paragraph">
<p>Les espaces de nom sont des emplacements permettant d&#8217;isoler tout un ensemble applicatif au sein du cluster Kubernetes.
Il est ainsi possible par l&#8217;intermédiaire des espaces de nom de gérer par exemple la même application dans différents namespace. Le cas le plus souvent utilisé est celui des environnements et d&#8217;une même application.
Un nom ne peut être utilisé deux fois dans un namespace mais peut apparaitre plusieurs fois dans différents namespaces.</p>
</div>
<div class="paragraph">
<p>Pour créer un espace de nom :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">kubectl create ns mon-espace</code></pre>
</div>
</div>
<div class="paragraph">
<p>pour vérifier son existence</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">kubectl get ns mon-espace</code></pre>
</div>
</div>
<div class="paragraph">
<p>qui donnera</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">NAME         STATUS    AGE
mon-espace   Active    46s</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
La suppression d&#8217;un namesapce engendre la suppression de l&#8217;ensemble des éléments qui le compose (Deployment, Pod ,etc&#8230;&#8203;)
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_ce_qui_ne_sera_pas_vu_dans_ce_lab_2">Ce qui ne sera pas vu dans ce lab</h3>
<div class="paragraph">
<p>Il reste encore beaucoup de chose à voir&#8230;&#8203;</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Les Ingress : la plateforme lab ne permet pas de le réaliser.</p>
</li>
<li>
<p>Les Storage : Élément de persistance et de stockage au sein de Kubernetes.</p>
</li>
<li>
<p>Les ConfigMap : permettant de configurer une/des applications</p>
</li>
<li>
<p>Les Secrets : permettant de gérer les mots de passe ou token</p>
</li>
<li>
<p>Les Jobs : traitement batch</p>
</li>
<li>
<p>Les rôles : pour l&#8217;administration etc &#8230;&#8203;
&#8230;&#8203;</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_kubectl">Kubectl</h3>
<div class="paragraph">
<p>plus d&#8217;infos &#8658; <a href="https://kubernetes.io/docs/reference/kubectl/overview/" class="bare">https://kubernetes.io/docs/reference/kubectl/overview/</a></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_annexe">Annexe</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_source">source</h3>
<div class="ulist">
<ul>
<li>
<p><a href="https://kubernetes.io/docs/tutorials/kubernetes-basics/" class="bare">https://kubernetes.io/docs/tutorials/kubernetes-basics/</a></p>
</li>
<li>
<p><a href="https://www.katacoda.com/courses/kubernetes" class="bare">https://www.katacoda.com/courses/kubernetes</a></p>
</li>
<li>
<p><a href="https://www.pluralsight.com/courses/getting-started-kubernetes" class="bare">https://www.pluralsight.com/courses/getting-started-kubernetes</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_nom_court_des_ressources_kubernetes">Nom court des ressources Kubernetes</h3>
<div class="paragraph">
<p>Un tableau est disponible à l&#8217;adresse suivante :</p>
</div>
<div class="paragraph">
<p><a href="https://kubernetes.io/docs/reference/kubectl/overview/#resource-types" class="bare">https://kubernetes.io/docs/reference/kubectl/overview/#resource-types</a></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_astuce">Astuce</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_écrire_dans_un_fichier_en_ligne_de_commande">Écrire dans un fichier en ligne de commande</h3>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">cat &gt; nomdufichier &lt;&lt; eof
&gt; blabla
&gt; eof</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2019-11-01 23:16:39 +0100
</div>
</div>
</body>
</html>